build-leg:
  stage: build
  tags: [linux]
  needs: [fetch-ci-scripts, quality-gate]
  image:
    name: $GAMS_CONTAINER_REGISTRY/qt-machines/leg/builder-${IMAGE_VERSION}:latest
    entrypoint: [""]   # prevent startup.sh
  script:
    - !reference [.get-gams]
    - !reference [.gams-folder-leg]
    - printf "GAMS_DISTRIB=/cache/gams-installs/`cat gams_folder_leg.txt`\n" > gamsinclude.txt
    - mkdir build
    - cd build
    - cmake -DCMAKE_VERBOSE_MAKEFILE:BOOL=ON ..
    - cmake --build . 2>&1 | tee build_log.txt
  artifacts:
    name: gams-cpp-leg
    expire_in: 2 hours
    paths: [gamsinclude.txt,build,build_log.txt]

build-deg:
  stage: build
  tags: [macos]
  needs: [fetch-ci-scripts, quality-gate]
  script:
    - !reference [.get-gams]
    - !reference [.gams-folder-deg]
    - printf "GAMS_DISTRIB=$HOME/cache/gams-installs/`cat gams_folder_deg.txt`\n" > gamsinclude.txt
    - mkdir build
    - cd build
    - cmake -DCMAKE_VERBOSE_MAKEFILE:BOOL=ON ..
    - cmake --build . 2>&1 | tee build_log.txt
  artifacts:
    name: gams-cpp-deg
    expire_in: 2 hours
    paths: [gamsinclude.txt,build,build_log.txt]

build-dac:
  stage: build
  tags: [macos-arm64]
  needs: [fetch-ci-scripts, quality-gate]
  script:
    - !reference [.get-gams]
    - !reference [.gams-folder-dac]
    - printf "GAMS_DISTRIB=$HOME/cache/gams-installs/`cat gams_folder_dac.txt`\n" > gamsinclude.txt
    - mkdir build
    - cd build
    - cmake -DCMAKE_VERBOSE_MAKEFILE:BOOL=ON ..
    - cmake --build . 2>&1 | tee build_log.txt
  artifacts:
    name: gams-cpp-dac
    expire_in: 2 hours
    paths: [gamsinclude.txt,build,build_log.txt]

build-wei:
  stage: build
  tags: [windows]
  needs: [fetch-ci-scripts, quality-gate]
  image:
    name: $MACHINES_CONTAINER_REG/wei/builder-full
  script:
    - !reference [.get-gams-wei]
    - !reference [.gams-folder-wei]
    - $gmsdirname = Get-Content mygmsdir.tmp -Raw
    - Invoke-Expression "& 'C:\\Cache\\gams-installs\\$gmsdirname\\gams.exe'"
    - echo "GAMS_DISTRIB=C:/Cache/gams-installs/$gmsdirname" > gamsinclude.txt
    - Add-Content gamsinclude.txt "`n"
    - mkdir build
    - cd build
    - cmake -DCMAKE_VERBOSE_MAKEFILE:BOOL=ON ..
    - cmake --build  . --config Release | Tee-Object -FilePath 'build_log.txt'
  artifacts:
    name: gams-cpp-wei
    expire_in: 2 hours
    paths: [gamsinclude.txt,build,build_log.txt]
