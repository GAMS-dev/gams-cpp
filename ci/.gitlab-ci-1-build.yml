build-leg:
  stage: build
  when: on_success
  tags: [linux]
  needs: [install-gamsdist-leg,fetch-prerequisites]
  image:
    name: $GAMS_CONTAINER_REGISTRY/qt-machines/leg/builder-testing:latest
    entrypoint: [""]   # prevent startup.sh
  script:
    - printf "GAMS_DISTRIB=$(pwd)/gamsdist\n" > gamsinclude.txt
    - mkdir build
    - cd build
    - cmake -DCMAKE_VERBOSE_MAKEFILE:BOOL=ON ..
    - cmake --build . 2>&1 | tee build_log.txt
    - python3 ../ci/report_for_log.py gcc build_log.txt ../warnings.xml
  artifacts:
    name: gams-cpp-leg
    expire_in: 2 hours
    paths: [gamsinclude.txt,build,build_log.txt]
    reports:
      junit: warnings.xml

build-deg:
  stage: build
  when: on_success
  tags: [macos]
  needs: [install-gamsdist-dac,fetch-prerequisites]
  script:
    - printf "GAMS_DISTRIB=$(pwd)/gamsdist\n" > gamsinclude.txt
    - mkdir build
    - cd build
    - cmake -DCMAKE_VERBOSE_MAKEFILE:BOOL=ON ..
    - cmake --build . 2>&1 | tee build_log.txt
    - python3 ../ci/report_for_log.py clang build_log.txt ../warnings.xml
  artifacts:
    name: gams-cpp-deg
    expire_in: 2 hours
    paths: [gamsinclude.txt,build,build_log.txt]
    reports:
      junit: warnings.xml

build-dac:
  stage: build
  when: on_success
  tags: [macos-arm64]
  needs: [install-gamsdist-deg,fetch-prerequisites]
  script:
    - printf "GAMS_DISTRIB=$(pwd)/gamsdist\n" > gamsinclude.txt
    - mkdir build
    - cd build
    - cmake -DCMAKE_VERBOSE_MAKEFILE:BOOL=ON ..
    - cmake --build . 2>&1 | tee build_log.txt
    - python3 ../ci/report_for_log.py clang build_log.txt ../warnings.xml
  artifacts:
    name: gams-cpp-dac
    expire_in: 2 hours
    paths: [gamsinclude.txt,build,build_log.txt]
    reports:
      junit: warnings.xml

build-wei:
  stage: build
  when: on_success
  tags: [windows]
  needs: [install-gamsdist-wei,fetch-prerequisites]
  image:
    name: $GAMS_CONTAINER_REGISTRY/qt-machines/wei/builder-qt6:latest
  script:
    - ('GAMS_DISTRIB=', $(Get-Location).ToString().Replace('\','/'), '/gamsdist') -join "" > gamsinclude.txt
    - Add-Content gamsinclude.txt "`n"
    - mkdir build
    - cd build
    - cmake -DCMAKE_VERBOSE_MAKEFILE:BOOL=ON ..
    - cmake --build  . --config Release | Tee-Object -FilePath 'build_log.txt'
    - python ../ci/report_for_log.py msvc build_log.txt ../warnings.xml
  artifacts:
    name: gams-cpp-wei
    expire_in: 2 hours
    paths: [gamsinclude.txt,build,build_log.txt]
    reports:
      junit: warnings.xml
